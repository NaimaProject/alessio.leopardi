---
- name: Check if system is already joined to domain
  command: realm list
  register: realm_status
  changed_when: false
  failed_when: false

- name: Set domain join status fact
  set_fact:
    already_joined: "{{ domain_name in realm_status.stdout }}"

- name: Discover the domain
  command: realm discover {{ domain_name }}
  register: realm_discover
  changed_when: false
  failed_when: realm_discover.rc != 0
  when: not already_joined

- name: Verify domain is discoverable
  assert:
    that:
      - realm_discover.rc == 0
      - "'domain-name' in realm_discover.stdout"
    fail_msg: "Domain {{ domain_name }} could not be discovered"
    success_msg: "Domain {{ domain_name }} discovered successfully"
  when: not already_joined

- name: Create temporary password file
  tempfile:
    state: file
    suffix: .realm
  register: temp_password_file
  when: not already_joined
  no_log: true

- name: Write password to temporary file
  copy:
    content: "{{ domain_password }}"
    dest: "{{ temp_password_file.path }}"
    mode: '0600'
  when: not already_joined
  no_log: true

- name: Join the domain (using password file)
  shell: |
    cat {{ temp_password_file.path }} | realm join --user={{ domain_user }} {{ realm_join_options }} {{ domain_name }}
  no_log: true
  register: realm_join_result
  when: not already_joined
  failed_when: realm_join_result.rc != 0
  notify: restart sssd

- name: Remove temporary password file
  file:
    path: "{{ temp_password_file.path }}"
    state: absent
  when:
    - not already_joined
    - temp_password_file.path is defined
  no_log: true
