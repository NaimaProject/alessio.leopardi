---
- name: Check if system is already joined to domain
  command: realm list
  register: realm_status
  changed_when: false
  failed_when: false

- name: Set domain join status fact
  set_fact:
    already_joined: "{{ domain_name in realm_status.stdout }}"

- name: Discover the domain
  command: realm discover {{ domain_name }}
  register: realm_discover
  changed_when: false
  failed_when: realm_discover.rc != 0
  when: not already_joined

- name: Verify domain is discoverable
  assert:
    that:
      - realm_discover.rc == 0
      - "'domain-name' in realm_discover.stdout"
    fail_msg: "Domain {{ domain_name }} could not be discovered"
    success_msg: "Domain {{ domain_name }} discovered successfully"
  when: not already_joined

- name: Join the domain (using stdin for password)
  shell: |
    set -o pipefail
    realm join --user={{ domain_user }} {{ domain_name }} {{ realm_join_options }}
  args:
    stdin: "{{ domain_password }}"
    executable: /bin/bash
  no_log: true
  register: realm_join_result
  when: not already_joined
  failed_when: realm_join_result.rc != 0
  notify: restart sssd
