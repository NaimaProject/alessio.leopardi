---
- name: Join Domain using realmd (Standalone Playbook)
  hosts: all
  become: yes
  vars:
    # REQUIRED VARIABLES - Override these in your inventory or command line
    domain_name: example.com
    domain_user: adminuser
    # SECURITY: Use ansible-vault to encrypt this variable or pass via --extra-vars
    # Example: ansible-playbook join-domain-realid.yml --extra-vars "domain_password=$AD_PASSWORD"
    domain_password: "{{ domain_password | default('') }}"

    # OPTIONAL VARIABLES - Customize as needed
    # Place computer in specific OU (optional)
    # Example: "--computer-ou=OU=Linux,OU=Servers,DC=corp,DC=example,DC=com"
    realm_join_options: ""

    # Enable sudo for domain admins (default: false)
    sssd_configure_sudo: false

    # Enable SSH password authentication for domain users (default: false)
    sssd_configure_ssh: false

    # Domain admin group name (used when sssd_configure_sudo is true)
    domain_admin_group: "Domain Admins"

  tasks:
    - name: Validate required variables
      assert:
        that:
          - domain_name is defined
          - domain_name | length > 0
          - domain_user is defined
          - domain_user | length > 0
          - domain_password is defined
          - domain_password | length > 0
        fail_msg: "Required variables (domain_name, domain_user, domain_password) must be defined"
        success_msg: "All required variables are defined"

    - name: Install base packages for realm
      package:
        name:
          - realmd
          - sssd
          - adcli
          - samba-common-tools
        state: present

    - name: Install distribution-specific packages (RHEL/CentOS/Rocky/Alma)
      package:
        name:
          - oddjob
          - oddjob-mkhomedir
          - sssd-tools
          - krb5-workstation
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install distribution-specific packages (Debian/Ubuntu)
      package:
        name:
          - libnss-sss
          - libpam-sss
          - packagekit
        state: present
      when: ansible_os_family == "Debian"

    - name: Check if system is already joined to domain
      command: realm list
      register: realm_status
      changed_when: false
      failed_when: false

    - name: Set domain join status fact
      set_fact:
        already_joined: "{{ domain_name in realm_status.stdout }}"

    - name: Discover the domain
      command: realm discover {{ domain_name }}
      register: realm_discover
      changed_when: false
      failed_when: realm_discover.rc != 0
      when: not already_joined

    - name: Verify domain is discoverable
      assert:
        that:
          - realm_discover.rc == 0
          - "'domain-name' in realm_discover.stdout"
        fail_msg: "Domain {{ domain_name }} could not be discovered"
        success_msg: "Domain {{ domain_name }} discovered successfully"
      when: not already_joined

    - name: Join the domain (using stdin for password - secure method)
      shell: |
        set -o pipefail
        realm join --user={{ domain_user }} {{ domain_name }} {{ realm_join_options }}
      args:
        stdin: "{{ domain_password }}"
        executable: /bin/bash
      no_log: true
      register: realm_join_result
      when: not already_joined
      failed_when: realm_join_result.rc != 0

    - name: Enable home directory creation on login (RHEL/CentOS)
      service:
        name: oddjobd
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"

    - name: Configure SSSD to create home directories (Debian/Ubuntu)
      lineinfile:
        path: /etc/pam.d/common-session
        line: "session optional pam_mkhomedir.so skel=/etc/skel umask=077"
        regexp: '^session\s+optional\s+pam_mkhomedir\.so'
        insertafter: EOF
        state: present
      when: ansible_os_family == "Debian"

    - name: Allow domain users to login via SSH
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        state: present
      when: sssd_configure_ssh | default(false)
      notify: restart sshd

    - name: Configure sudo for domain admins
      copy:
        content: |
          # Ansible managed - Allow {{ domain_admin_group }} group full sudo access
          %{{ domain_admin_group }} ALL=(ALL) ALL
        dest: /etc/sudoers.d/domain_admins
        owner: root
        group: root
        mode: '0440'
        validate: 'visudo -cf %s'
      when: sssd_configure_sudo | default(false)

    - name: Ensure SSSD service is enabled and started
      service:
        name: sssd
        state: started
        enabled: yes

    - name: Verify domain join status
      command: realm list
      register: realm_list_final
      changed_when: false

    - name: Display realm information
      debug:
        var: realm_list_final.stdout_lines

    - name: Confirm successful domain join
      assert:
        that:
          - domain_name in realm_list_final.stdout
        fail_msg: "Domain join verification failed - {{ domain_name }} not found in realm list"
        success_msg: "Successfully joined to domain {{ domain_name }}"

  handlers:
    - name: restart sssd
      service:
        name: sssd
        state: restarted

    - name: restart sshd
      service:
        name: "{{ 'sshd' if ansible_os_family == 'RedHat' else 'ssh' }}"
        state: restarted