---
- name: Join Domain using realmd
  hosts: all
  become: yes
  vars:
    domain_name: example.com
    domain_user: adminuser
    # Use ansible-vault to encrypt this variable or pass via --extra-vars
    # domain_password should be provided securely, not hardcoded
    domain_password: "{{ domain_password | default('') }}"

    # Access control settings (optional)
    ad_restrict_access: false
    ad_login_groups: []
    # Example: ad_login_groups: ["linux-users", "administrators"]

    # Sudo configuration (optional)
    ad_configure_sudo: false
    ad_sudo_groups: []
    # Example: ad_sudo_groups: ["domain admins", "linux-admins"]
    ad_sudoers_file: "ad_sudoers"

  tasks:
    - name: Validate required variables
      assert:
        that:
          - domain_name is defined
          - domain_name | length > 0
          - domain_user is defined
          - domain_user | length > 0
          - domain_password is defined
          - domain_password | length > 0
        fail_msg: "Required variables (domain_name, domain_user, domain_password) must be defined"
        success_msg: "All required variables are defined"
      tags:
        - always
        - validate

    - name: Install base packages for realm
      package:
        name:
          - realmd
          - sssd
          - adcli
          - samba-common-tools
        state: present
      tags: [packages, install]

    - name: Install distribution-specific packages (RHEL/CentOS/Rocky/Alma)
      package:
        name:
          - oddjob
          - oddjob-mkhomedir
          - sssd-tools
          - krb5-workstation
        state: present
      when: ansible_os_family == "RedHat"
      tags: [packages, install]

    - name: Install distribution-specific packages (Debian/Ubuntu)
      package:
        name:
          - libnss-sss
          - libpam-sss
          - packagekit
        state: present
      when: ansible_os_family == "Debian"
      tags: [packages, install]

    - name: Check if system is already joined to domain
      command: realm list
      register: realm_status
      changed_when: false
      failed_when: false
      tags: [join, domain]

    - name: Set domain join status fact
      set_fact:
        already_joined: "{{ domain_name in realm_status.stdout }}"
      tags: [join, domain]

    - name: Discover the domain
      command: realm discover {{ domain_name }}
      register: realm_discover
      changed_when: false
      failed_when: realm_discover.rc != 0
      when: not already_joined
      tags: [join, domain]

    - name: Verify domain is discoverable
      assert:
        that:
          - realm_discover.rc == 0
          - "'domain-name' in realm_discover.stdout"
        fail_msg: "Domain {{ domain_name }} could not be discovered"
        success_msg: "Domain {{ domain_name }} discovered successfully"
      when: not already_joined
      tags: [join, domain]

    - name: Create temporary password file
      tempfile:
        state: file
        suffix: .realm
      register: temp_password_file
      when: not already_joined
      no_log: true
      tags: [join, domain]

    - name: Write password to temporary file
      copy:
        content: "{{ domain_password }}"
        dest: "{{ temp_password_file.path }}"
        mode: '0600'
      when: not already_joined
      no_log: true
      tags: [join, domain]

    - name: Join the domain (using password file)
      shell: |
        cat {{ temp_password_file.path }} | realm join --user={{ domain_user }} {{ domain_name }}
      no_log: true
      register: realm_join_result
      when: not already_joined
      failed_when: realm_join_result.rc != 0
      tags: [join, domain]

    - name: Remove temporary password file
      file:
        path: "{{ temp_password_file.path }}"
        state: absent
      when:
        - not already_joined
        - temp_password_file.path is defined
      no_log: true
      tags: [join, domain]

    - name: Enable home directory creation on login (RHEL/CentOS)
      service:
        name: oddjobd
        state: started
        enabled: yes
      when:
        - ansible_os_family == "RedHat"
        - not already_joined

    - name: Configure SSSD to create home directories (Debian/Ubuntu)
      lineinfile:
        path: /etc/pam.d/common-session
        line: "session optional pam_mkhomedir.so skel=/etc/skel umask=077"
        regexp: '^session\s+optional\s+pam_mkhomedir\.so'
        insertafter: EOF
        state: present
      when: ansible_os_family == "Debian"
      tags: [configure, config]

    - name: Ensure SSSD service is enabled and started
      service:
        name: sssd
        state: started
        enabled: yes
      tags: [configure, config]

    # === ACCESS CONTROL AND SUDO CONFIGURATION ===

    - name: Deny access to all users (preparing for group-based access)
      command: realm deny --all
      when: ad_restrict_access | bool
      changed_when: false
      tags: [access, security]

    - name: Permit login only to specific AD groups
      command: realm permit -g "{{ item }}"
      loop: "{{ ad_login_groups }}"
      when:
        - ad_restrict_access | bool
        - ad_login_groups | length > 0
      changed_when: false
      tags: [access, security]

    - name: Verify access control configuration
      command: realm list
      register: realm_permissions
      changed_when: false
      when: ad_restrict_access | bool
      tags: [access, security]

    - name: Display configured access groups
      debug:
        msg: "Access restricted to groups: {{ ad_login_groups | join(', ') }}"
      when:
        - ad_restrict_access | bool
        - ad_login_groups | length > 0
      tags: [access, security]

    - name: Create sudoers directory if not exists
      file:
        path: /etc/sudoers.d
        state: directory
        mode: '0750'
        owner: root
        group: root
      when: ad_configure_sudo | bool
      tags: [sudo, security]

    - name: Configure sudo for AD groups
      lineinfile:
        path: "/etc/sudoers.d/{{ ad_sudoers_file }}"
        line: '%{{ item }}  ALL=(ALL)  ALL'
        create: yes
        mode: '0440'
        owner: root
        group: root
        validate: 'visudo -cf %s'
      loop: "{{ ad_sudo_groups }}"
      when:
        - ad_configure_sudo | bool
        - ad_sudo_groups | length > 0
      tags: [sudo, security]

    - name: Display configured sudo groups
      debug:
        msg: "Sudo privileges granted to groups: {{ ad_sudo_groups | join(', ') }}"
      when:
        - ad_configure_sudo | bool
        - ad_sudo_groups | length > 0
      tags: [sudo, security]

    - name: Validate sudoers configuration
      command: visudo -c
      changed_when: false
      when: ad_configure_sudo | bool
      tags: [sudo, security]

    - name: Verify domain join status
      command: realm list
      register: realm_list_final
      changed_when: false
      tags:
        - always
        - verify

    - name: Display realm information
      debug:
        var: realm_list_final.stdout_lines
      tags:
        - always
        - verify

    - name: Confirm successful domain join
      assert:
        that:
          - domain_name in realm_list_final.stdout
        fail_msg: "Domain join verification failed - {{ domain_name }} not found in realm list"
        success_msg: "Successfully joined to domain {{ domain_name }}"
      tags:
        - always
        - verify